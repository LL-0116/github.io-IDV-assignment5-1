<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Adversarial Attack Accuracy Heatmap</title>
    <!-- More stable D3.js CDN with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
    <script>
        // Fallback load if main CDN fails
        if (typeof d3 === 'undefined') {
            document.write('<script src="https://unpkg.com/d3@7/dist/d3.min.js"><\/script>');
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 24px; }
        /* Loading indicator style */
        .loading { text-align: center; font-size: 18px; color: #666; margin: 50px 0; }
        .tooltip { 
            position: absolute; 
            background-color: rgba(0, 0, 0, 0.8); 
            color: white; 
            padding: 8px 12px; 
            border-radius: 4px; 
            font-size: 14px; 
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 0.3s; 
            z-index: 100;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .legend { margin-top: 20px; text-align: center; }
        .legend-title { font-size: 14px; color: #666; margin-bottom: 8px; }
        /* Ensure SVG container is visible, remove height restrictions */
        #chart { 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; /* Align to top to avoid bottom cutoff */
            padding: 20px 0;
        }
        /* Scrollbar optimization for long content */
        html { overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Heatmap of Model Accuracy Under Different Attack Methods</h1>
        <div id="chart">
            <!-- Loading indicator -->
            <div class="loading">Chart loading...please wait</div>
        </div>
        <div class="tooltip" id="tooltip"></div>
        <div class="legend" id="legend"></div>
    </div>

    <script>
        // Execute only after D3 is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof d3 === 'undefined') {
                d3.select('.loading').text('D3.js loading failed, please check your network connection and refresh the page');
                return;
            }

            // 1. Data preprocessing (keep original data intact)
            const data = [
                { Attack: "No Attack", ERM: 94.85, DA: 94.21, PGDT: 84.38, TRADES: 80.42, MART: 81.54, RS: 89.45, IBP: 48.40, PRL: 93.82, TandT: 94.23 },
                { Attack: "TIFGSM", ERM: 35.10, DA: 33.00, PGDT: 65.70, TRADES: 62.90, MART: 69.10, RS: 45.40, IBP: 40.20, PRL: 34.00, TandT: 92.80 },
                { Attack: "MIFGSM", ERM: 0.00, DA: 0.00, PGDT: 50.90, TRADES: 51.90, MART: 50.50, RS: 5.80, IBP: 38.10, PRL: 0.00, TandT: 92.80 },
                { Attack: "DIFGSM", ERM: 1.00, DA: 0.00, PGDT: 51.75, TRADES: 50.50, MART: 53.60, RS: 4.10, IBP: 38.10, PRL: 3.10, TandT: 92.80 },
                { Attack: "VMIFGSM", ERM: 0.00, DA: 0.00, PGDT: 51.10, TRADES: 50.90, MART: 51.90, RS: 4.10, IBP: 38.10, PRL: 0.00, TandT: 93.90 },
                { Attack: "TPGD", ERM: 38.10, DA: 39.20, PGDT: 69.30, TRADES: 69.10, MART: 70.10, RS: 48.50, IBP: 50.00, PRL: 28.90, TandT: 91.80 },
                { Attack: "FGSM", ERM: 29.90, DA: 25.80, PGDT: 57.95, TRADES: 54.60, MART: 61.90, RS: 28.90, IBP: 38.10, PRL: 25.80, TandT: 93.80 },
                { Attack: "RFGSM", ERM: 0.00, DA: 0.00, PGDT: 49.15, TRADES: 50.40, MART: 48.50, RS: 3.70, IBP: 38.10, PRL: 0.00, TandT: 90.00 },
                { Attack: "BIM", ERM: 0.00, DA: 0.00, PGDT: 52.00, TRADES: 57.20, MART: 47.40, RS: 2.10, IBP: 38.10, PRL: 0.00, TandT: 90.70 },
                { Attack: "FAB", ERM: 1.00, DA: 2.10, PGDT: 43.00, TRADES: 46.40, MART: 40.20, RS: 5.30, IBP: 38.10, PRL: 4.10, TandT: 90.10 },
                { Attack: "CW", ERM: 0.00, DA: 0.00, PGDT: 32.20, TRADES: 35.10, MART: 29.90, RS: 1.00, IBP: 40.20, PRL: 1.00, TandT: 92.90 },
                { Attack: "UPGD", ERM: 0.00, DA: 0.00, PGDT: 49.85, TRADES: 50.50, MART: 49.80, RS: 5.10, IBP: 38.10, PRL: 0.00, TandT: 93.80 },
                { Attack: "FFGSM", ERM: 19.60, DA: 23.70, PGDT: 60.55, TRADES: 55.70, MART: 66.00, RS: 33.00, IBP: 42.30, PRL: 29.90, TandT: 92.80 },
                { Attack: "Jitter", ERM: 11.30, DA: 12.40, PGDT: 48.15, TRADES: 47.40, MART: 49.50, RS: 34.00, IBP: 39.20, PRL: 24.70, TandT: 90.70 },
                { Attack: "PGD", ERM: 0.00, DA: 0.00, PGDT: 57.40, TRADES: 54.60, MART: 60.80, RS: 7.20, IBP: 40.20, PRL: 0.00, TandT: 91.80 },
                { Attack: "EOTPGD", ERM: 0.00, DA: 0.00, PGDT: 50.10, TRADES: 50.30, MART: 50.50, RS: 3.00, IBP: 38.10, PRL: 0.00, TandT: 90.70 },
                { Attack: "APGD", ERM: 0.00, DA: 0.00, PGDT: 48.40, TRADES: 51.00, MART: 46.40, RS: 1.00, IBP: 38.10, PRL: 0.00, TandT: 90.70 },
                { Attack: "NIFGSM", ERM: 0.00, DA: 0.00, PGDT: 57.95, TRADES: 56.70, MART: 59.80, RS: 7.20, IBP: 38.10, PRL: 1.00, TandT: 92.80 },
                { Attack: "SiniFGSM", ERM: 4.10, DA: 1.00, PGDT: 59.00, TRADES: 56.70, MART: 61.90, RS: 23.70, IBP: 38.10, PRL: 12.40, TandT: 93.70 },
                { Attack: "VNIFGSM", ERM: 0.00, DA: 0.00, PGDT: 50.45, TRADES: 53.00, MART: 48.50, RS: 5.10, IBP: 38.10, PRL: 0.00, TandT: 92.90 },
                { Attack: "APGDT", ERM: 0.00, DA: 0.00, PGDT: 40.90, TRADES: 44.30, MART: 38.10, RS: 0.00, IBP: 38.10, PRL: 0.00, TandT: 88.70 },
                { Attack: "Square", ERM: 0.00, DA: 1.00, PGDT: 50.40, TRADES: 54.00, MART: 47.40, RS: 3.10, IBP: 38.10, PRL: 2.10, TandT: 88.08 },
                { Attack: "Add Gaussian Noise", ERM: 25.80, DA: 43.30, PGDT: 79.10, TRADES: 78.40, MART: 80.40, RS: 74.20, IBP: 42.30, PRL: 45.40, TandT: 87.60 },
                { Attack: "OnePixel", ERM: 79.40, DA: 83.50, PGDT: 78.05, TRADES: 74.20, MART: 82.50, RS: 83.50, IBP: 42.50, PRL: 80.40, TandT: 89.70 },
                { Attack: "Pixle", ERM: 0.00, DA: 0.00, PGDT: 12.55, TRADES: 11.30, MART: 14.40, RS: 1.00, IBP: 10.30, PRL: 0.00, TandT: 17.50 },
                { Attack: "PGDL2", ERM: 1.00, DA: 0.00, PGDT: 35.80, TRADES: 36.10, MART: 36.10, RS: 5.20, IBP: 36.10, PRL: 0.00, TandT: 92.90 }
            ];

            // Remove loading indicator
            d3.select('.loading').remove();

            // 2. Chart configuration (key fix: dynamically calculate sufficient height)
            const containerWidth = document.querySelector('.container').clientWidth;
            const margin = { 
                top: 60, 
                right: 30, 
                bottom: 120, // Expand bottom margin to ensure full X-axis text display
                left: 160    // Expand left margin to fit long attack method names
            };
            const attackCount = data.length; // Number of attack methods (26)
            const rectHeight = 35; // Height of each rectangle (increased for better readability)
            const width = Math.min(containerWidth - 40, 1200) - margin.left - margin.right;
            const height = attackCount * rectHeight; // Dynamically calculate total height to fit all attack methods

            // 3. Create SVG container (height adapts to data volume)
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom) // Total height = content height + margins
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // 4. Define dimensions (add data validation)
            const attacks = data.map(d => d.Attack).filter(Boolean);
            const models = Object.keys(data[0] || {}).filter(key => key !== "Attack").filter(Boolean);

            if (attacks.length === 0 || models.length === 0) {
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .text("Data loading failed, please check the data format");
                return;
            }

            // 5. Scales (optimize Y-axis bandwidth)
            const x = d3.scaleBand()
                .domain(models)
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleBand()
                .domain(attacks)
                .range([0, height])
                .padding(0.05); // Reduce Y-axis padding to fit all rectangles

            // Color scale (optimize color range for better contrast)
            const colorScale = d3.scaleSequential()
                .domain([0, 100])
                .interpolator(d3.interpolateRdYlGn); // Red→Yellow→Green, intuitive for accuracy

            // 6. Draw heatmap rectangles (ensure full display)
            const heatmapData = data.flatMap(d => 
                models.map(model => ({
                    attack: d.Attack,
                    model: model,
                    value: typeof d[model] === 'number' ? d[model] : 0 // Handle abnormal values
                }))
            );

            svg.selectAll("rect")
                .data(heatmapData)
                .enter()
                .append("rect")
                .attr("x", d => x(d.model))
                .attr("y", d => y(d.attack))
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .attr("fill", d => colorScale(d.value))
                .attr("stroke", "#fff") // White border to distinguish rectangles
                .attr("stroke-width", 0.5)
                // Fade-in transition
                .style("opacity", 0)
                .transition()
                .duration(1500)
                .delay((d, i) => i * 3)
                .style("opacity", 1);

            // 7. Interactive effects (optimize tooltip)
            const tooltip = d3.select("#tooltip");
            svg.selectAll("rect")
                .on("mouseover", function(event, d) {
                    const tooltipX = Math.min(event.pageX + 10, window.innerWidth - 150);
                    const tooltipY = Math.max(event.pageY - 20, 20);

                    tooltip.style("opacity", 1)
                        .html(`
                            <strong>Attack Method:</strong> ${d.attack}<br>
                            <strong>Model:</strong> ${d.model}<br>
                            <strong>Accuracy:</strong> ${d.value.toFixed(2)}%
                        `)
                        .style("left", tooltipX + "px")
                        .style("top", tooltipY + "px");

                    d3.select(this)
                        .style("stroke", "#333")
                        .style("stroke-width", 2)
                        .style("opacity", 0.9);
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                    d3.select(this)
                        .style("stroke", "#fff")
                        .style("stroke-width", 0.5)
                        .style("opacity", 1);
                });

            // 8. Axes (key fix: ensure text doesn't overflow)
            // X-axis (Models)
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .attr("text-anchor", "end")
                .attr("font-size", 11)
                .attr("dy", "0.5em") // Adjust Y offset to prevent text cutoff
                .attr("fill", "#333")
                .style("white-space", "nowrap");

            // Y-axis (Attack Methods)
            svg.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .attr("font-size", 10)
                .attr("fill", "#333")
                .attr("dx", "-0.5em") // Adjust X offset to prevent text overflow on left
                .style("text-anchor", "end");

            // Axis labels (optimize position)
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 30) // Move label down to avoid overlapping with X-axis text
                .attr("text-anchor", "middle")
                .attr("font-size", 16)
                .attr("font-weight", "bold")
                .attr("fill", "#333")
                .text("Models");

            svg.append("text")
                .attr("transform", `rotate(-90) translate(${-height / 2}, -${margin.left - 70})`) // Move label left
                .attr("text-anchor", "middle")
                .attr("font-size", 16)
                .attr("font-weight", "bold")
                .attr("fill", "#333")
                .text("Attack Methods");

            // 9. Color legend (optimize position to avoid cutoff)
            const legendWidth = Math.min(width, 500);
            const legendHeight = 20;
            const legendSvg = d3.select("#legend")
                .append("svg")
                .attr("width", legendWidth + 40)
                .attr("height", legendHeight + 40); // Increase legend height to ensure full tick display

            // Legend title
            legendSvg.append("text")
                .attr("x", legendWidth / 2)
                .attr("y", 15)
                .attr("text-anchor", "middle")
                .attr("font-size", 14)
                .attr("fill", "#666")
                .text("Accuracy");

            // Legend gradient
            const defs = legendSvg.append("defs");
            const gradient = defs.append("linearGradient")
                .attr("id", "colorGradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%");

            gradient.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", d3.interpolateRdYlGn(0))
                .attr("stop-opacity", 1);

            gradient.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", d3.interpolateRdYlGn(1))
                .attr("stop-opacity", 1);

            // Legend rectangle
            legendSvg.append("rect")
                .attr("x", 20)
                .attr("y", 25)
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#colorGradient)")
                .style("stroke", "#ccc")
                .style("stroke-width", 1);

            // Legend ticks
            const legendScale = d3.scaleLinear()
                .domain([0, 100])
                .range([20, 20 + legendWidth]);

            const legendAxis = d3.axisBottom(legendScale)
                .ticks(5)
                .tickFormat(d => d + "%");

            legendSvg.append("g")
                .attr("transform", `translate(0, ${25 + legendHeight})`)
                .call(legendAxis)
                .selectAll("text")
                .attr("font-size", 11)
                .attr("fill", "#666");
        });
    </script>
</body>
</html>